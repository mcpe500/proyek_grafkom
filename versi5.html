<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Render .glb with Three.js</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        .hide-cursor {
            cursor: none;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>
    <script>
        var scene, renderer, controls, camera;
        var moveForward = false;
        var moveBackward = false;
        var moveLeft = false;
        var moveRight = false;

        var raycaster = new THREE.Raycaster();
        var downRay = new THREE.Vector3(0, -0.1, 0);
        var previousPosition = new THREE.Vector3();

        var clouds = [];
        var objects = [];
        var eagleEyeMode = false;
        
        var ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(0, 70, 0);
        var hemisphereLight = new THREE.HemisphereLight(0xffffff, 1);
        hemisphereLight.position.set(0, 70, 0);
        var shadowSize = 150;
        var orbitRadius = 100; // Radius orbit matahari
        var sunAngle = 0;

        var eagleEyeCameraPosition = new THREE.Vector3(30, 20, 30);
        var eagleEyeCameraLookAt = new THREE.Vector3(0, 0, 0);
        var firstPersonCameraPosition = new THREE.Vector3();
        var firstPersonCameraRotation = new THREE.Euler();

        function switchToFirstPersonMode() {
            camera.position.copy(firstPersonCameraPosition);
            camera.rotation.copy(firstPersonCameraRotation);
        }

        function switchToEagleEyeMode() {
            firstPersonCameraPosition.copy(camera.position);
            firstPersonCameraRotation.copy(camera.rotation);

            camera.position.copy(eagleEyeCameraPosition);
            camera.lookAt(eagleEyeCameraLookAt);
        }

        function addObjectToCheck(object) {
            objects.push(object);
        }

        function loadObject(objectFile, x, y, z, scale) {
            var loader = new THREE.GLTFLoader();
            loader.load(objectFile, function (gltf) {
                var object = gltf.scene;
                object.position.set(x, y, z);
                object.scale.set(scale, scale, scale);
                object.traverse(function(node){
                    if(node.isMesh){
                        node.receiveShadow = true;
                        node.castShadow = true
                    }
                })
                object.receiveShadow = true;
                scene.add(object);
                addObjectToCheck(object);
            });
        }


        function init() {
            scene = new THREE.Scene();
            renderer = new THREE.WebGLRenderer();
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            scene.add(hemisphereLight);

            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 4096;
            directionalLight.shadow.mapSize.height = 4096;
            directionalLight.shadow.camera.top += shadowSize;
            directionalLight.shadow.camera.bottom -= shadowSize;
            directionalLight.shadow.camera.left -= shadowSize;
            directionalLight.shadow.camera.right += shadowSize;
            scene.add(directionalLight);
            scene.add(new THREE.CameraHelper(directionalLight.shadow.camera));

            loadObject("./textures/barn.glb", -20, 2.8, 20, 1);
            loadObject("./textures/scarecrow.glb", 10, 0, 10, 1);
            loadObject("./textures/wooden_fence.glb", 10, 0, 10, 1);

            var cloudFiles = ["./textures/cloud_1.glb", "./textures/cloud_2.glb", "./textures/cloud_3.glb", "./textures/cloud_4.glb"];
            function loadCloud(cloudFile, x, y, z) {
                var loader = new THREE.GLTFLoader();
                loader.load(cloudFile, function (gltf) {
                    var cloud = gltf.scene;
                    cloud.receiveShadow = false;
                    cloud.position.set(x, y, z);
                    cloud.scale.set(5, 5, 5);
                    cloud.traverse(function(node){
                        if(node.isMesh){
                            node.castShadow = true
                        }
                    });
                    scene.add(cloud);
                    clouds.push(cloud);
                });
            }
            var cloudGroup = new THREE.Group();
            for (var i = 0; i < 30; i++) {
                for (var j = 0; j < cloudFiles.length; j++) {
                    var x = Math.random() * 400 - 200;
                    var y = Math.random() * 20 + 30;
                    var z = Math.random() * 400 - 200;
                    loadCloud(cloudFiles[j], x, y, z);
                }
            }
            scene.add(cloudGroup);
            cloudGroup.add(ambientLight);

            var grassGeometry = new THREE.PlaneGeometry(200, 200);
            var grassMaterial = new THREE.MeshStandardMaterial({ color: 0x996633 });
            var grass = new THREE.Mesh(grassGeometry, grassMaterial);
            grass.receiveShadow = true;
            grass.rotation.x = -Math.PI / 2;
            grass.position.set(0, 0, 0);
            scene.add(grass);
            
            // var fieldGeometry = new THREE.PlaneGeometry(50, 50);
            // var fieldMaterial = new THREE.MeshStandardMaterial({ color: 0x996633 });
            // var field = new THREE.Mesh(fieldGeometry, fieldMaterial);
            // field.rotation.x = -Math.PI / 2;
            // field.receiveShadow = true;
            // field.position.set(0, 0.005, 0);
            // scene.add(field);

            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 50, 200);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 20;

            controls = new THREE.PointerLockControls(camera, document.body);
            scene.add(controls.getObject());

            var onMouseDown = function (event) {
                controls.lock();
            };

            var onPointerLockChange = function () {
                controls.enabled = document.pointerLockElement === document.body;
            };

            var onKeyDown = function (event) {
                switch (event.keyCode) {
                    case 87: // W
                        moveForward = true;
                        break;
                    case 65: // A
                        moveLeft = true;
                        break;
                    case 83: // S
                        moveBackward = true;
                        break;
                    case 68: // D
                        moveRight = true;
                        break;
                        case 49: // '1' untuk first person view
                        eagleEyeMode = false;
                        switchToFirstPersonMode();
                        break;
                    case 50: // '2' untuk eagle eye view
                        eagleEyeMode = true;
                        switchToEagleEyeMode();
                        break;
                }
            };

            var onKeyUp = function (event) {
                switch (event.keyCode) {
                    case 87: // W
                        moveForward = false;
                        break;
                    case 65: // A
                        moveLeft = false;
                        break;
                    case 83: // S
                        moveBackward = false;
                        break;
                    case 68: // D
                        moveRight = false;
                        break;
                }
            };

            window.addEventListener("mousedown", onMouseDown, false);
            document.addEventListener(
                "pointerlockchange",
                onPointerLockChange,
                false
            );
            window.addEventListener("keydown", onKeyDown, false);
            window.addEventListener("keyup", onKeyUp, false);
        }
        
        function checkCollision() {
            var raycasters = [];
            raycasters.push(new THREE.Raycaster(controls.getObject().position, new THREE.Vector3(0, 0, -1)));
            raycasters.push(new THREE.Raycaster(controls.getObject().position, new THREE.Vector3(0, 0, 1)));
            raycasters.push(new THREE.Raycaster(controls.getObject().position, new THREE.Vector3(-1, 0, 0)));
            raycasters.push(new THREE.Raycaster(controls.getObject().position, new THREE.Vector3(1, 0, 0)));
            var intersected = false;
            raycasters.forEach(function (raycaster) {
                var intersects = raycaster.intersectObjects(objects, true);
                if (intersects.length > 0 && intersects[0].distance < 1) {
                    intersected = true;
                }
            });
            if (intersected) {
                controls.getObject().position.copy(previousPosition);
            } else {
                previousPosition.copy(controls.getObject().position);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            sunAngle += 0.001;
            directionalLight.position.x = Math.cos(sunAngle) * orbitRadius;
            directionalLight.position.y = Math.sin(sunAngle) * orbitRadius;
            directionalLight.position.z = 0;
            // hemisphereLight.position.x = Math.sin(time) * 20;
            // hemisphereLight.position.y = Math.sin(time) * 20;
            // hemisphereLight.position.z = Math.sin(time) * 20;


            var moveSpeed = 0.2;
            var moveVector = new THREE.Vector3();
            controls.getObject().getWorldDirection(moveVector);
            moveVector.y = 0;
            moveVector.normalize();

            if (!eagleEyeMode) {
                raycaster.set(controls.getObject().position, downRay);
                var intersects = raycaster.intersectObjects(scene.children, true);
    
                if (intersects.length > 0) {
                    if (intersects[0].distance - 1 > 0) {
                        controls.getObject().position.y -= 0.6;
                    }
                }
            }
            checkCollision();
            // Menggerakkan awan
            for (var i = 0; i < clouds.length; i++) {
                clouds[i].position.x += 0.1;
                
                if (clouds[i].position.x > 250) {
                    clouds[i].position.x = -250;
                    clouds[i].position.y = Math.random() * 20 + 30;
                    clouds[i].position.z = Math.random() * 400 - 200;
                }
            }

            if (true) {
                // Kontrol untuk first person mode
                if (moveForward)
                    controls
                        .getObject()
                        .position.add(moveVector.clone().multiplyScalar(moveSpeed));
                if (moveBackward)
                    controls
                        .getObject()
                        .position.sub(moveVector.clone().multiplyScalar(moveSpeed));
                if (moveLeft)
                    controls
                        .getObject()
                        .position.add(
                            moveVector
                                .clone()
                                .cross(controls.getObject().up)
                                .negate()
                                .multiplyScalar(moveSpeed)
                        );
                if (moveRight)
                    controls
                        .getObject()
                        .position.add(
                            moveVector
                                .clone()
                                .cross(controls.getObject().up)
                                .multiplyScalar(moveSpeed)
                        );
            }

            renderer.render(scene, camera);
        }

        init();
        animate();
    </script>
</body>
</html>
